<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>채용 공고 등록</title>
    <link rel="stylesheet" href="/static/css/common/common.css">
    <link rel="stylesheet" href="/static/css/jobopen/register.css">
</head>
<body>
<div class="flex-row">
    <div class="w300" th:insert="~{layout/company_side}"></div>
    <div class="flex-column flex1">
        <div th:insert="~{layout/header_no_logo}"></div>
        <div class="content">
            <div class="job-registration-form">
                <header class="form-header">
                    <h1>채용 공고 등록</h1>
                </header>
                <form id="jobForm" enctype="multipart/form-data" onsubmit="handleSubmit(event)">

                    <!-- 공고명 -->
                    <div class="form-group">
                        <label for="jobTitle">공고명</label>
                        <input type="text" id="jobTitle" name="jobTitle" placeholder="예: 프론트엔드 개발자 모집">
                    </div>

                    <!-- 서브타이틀 -->
                    <div class="form-group">
                        <label for="jobSubtitle">서브타이틀</label>
                        <input type="text" id="jobSubtitle" name="jobSubtitle" placeholder="예: 혁신적인 팀에서 함께할 인재를 찾습니다!"
                        >
                    </div>

                    <!-- 기업 이미지 -->
                    <div class="form-group">
                        <div class="upload-label">
                            <span class="label-title">이미지 등록</span>
                            <!-- 파일 업로드 버튼을 input[type="file"]과 연결 -->
                            <label for="companyImage" class="upload-button">파일 업로드</label>
                            <span class="upload-hint ml20">*최대 3장까지 업로드 가능합니다.</span>
                        </div>
                        <!-- 파일 입력 -->
                        <input type="file" id="companyImage" name="companyImage" accept="image/*" multiple
                               style="display: none;">

                        <!-- 미리보기 영역 -->
                        <div class="file-preview" id="filePreview">
                            <div class="default-img">이미지 없음</div>
                            <div class="default-img">이미지 없음</div>
                            <div class="default-img">이미지 없음</div>
                        </div>
                    </div>


                    <!-- 내용 -->
                    <div class="form-group">
                        <label for="jobDescription">내용</label>
                        <textarea id="jobDescription" name="jobDescription" placeholder="공고 상세 내용을 입력하세요" rows="5"
                        ></textarea>
                    </div>

                    <div class="form-group">
                        <label>채용 기간</label>
                        <div class="date-range-group">
                            <!-- 시작 날짜 -->
                            <div class="date-field">
                                <label for="startDate">시작 날짜</label>
                                <input type="datetime-local" id="startDate" name="startDate">
                            </div>

                            <!-- 마감 날짜 -->
                            <div class="date-field">
                                <label for="endDate">마감 날짜</label>
                                <input type="datetime-local" id="endDate" name="endDate">
                            </div>
                        </div>
                    </div>

                    <!-- 학력 -->
                    <div class="form-group">
                        <label for="education">학력</label>
                        <select id="education" name="education">
                            <option value="">선택하세요</option>
                            <option value="고졸">고졸</option>
                            <option value="대졸">대졸</option>
                            <option value="석사 이상">석사 이상</option>
                        </select>
                    </div>

                    <!-- 경력 -->
                    <div class="form-group">
                        <label for="experience">경력</label>
                        <select id="experience" name="experience">
                            <option value="">선택하세요</option>
                            <option value="신입">신입</option>
                            <option value="1년 이상">1년 이상</option>
                            <option value="3년 이상">3년 이상</option>
                        </select>
                    </div>

                    <!-- 기술 스택 -->
                    <div class="form-group">
                        <label>기술 스택</label>
                        <div class="skills-options">
                            <button type="button" class="skill-button" data-skill="JavaScript">JavaScript</button>
                            <button type="button" class="skill-button" data-skill="React">React</button>
                            <button type="button" class="skill-button" data-skill="CSS">CSS</button>
                            <button type="button" class="skill-button" data-skill="HTML">HTML</button>
                            <button type="button" class="skill-button" data-skill="Python">Python</button>
                            <button type="button" class="skill-button" data-skill="Python">Python</button>
                        </div>
                        <div class="selected-skills">
                            <p>선택된 스킬:</p>
                            <div class="selected-skill-list"></div>
                        </div>
                    </div>

                    <!-- 우대 사항 -->
                    <div class="form-group">
                        <label for="preferred">우대 사항</label>
                        <textarea id="preferred" name="preferred" placeholder="우대 조건을 입력하세요" rows="3"></textarea>
                    </div>

                    <!-- 근무 형태 -->
                    <div class="form-group">
                        <label for="employmentType">근무 형태</label>
                        <select id="employmentType" name="employmentType">
                            <option value="">선택하세요</option>
                            <option value="정규직">정규직</option>
                            <option value="계약직">계약직</option>
                        </select>
                    </div>

                    <!-- 근무 위치 -->
                    <div class="form-group">
                        <label for="workLocation">근무 위치</label>
                        <input type="text" id="workLocation" name="workLocation" placeholder="예: 서울특별시 강남구">
                    </div>
                    <!-- 등록 버튼 -->
                    <div class="form-actions">
                        <button type="submit" class="submit-button">공고 등록</button>
                    </div>


                </form>

            </div>
        </div>
    </div>

</div>
<footer th:insert="~{layout/footer}"></footer>
<script>
    let selectedFiles = [];

    $(document).ready(function () {
        const maxFiles = 3;

        // 시작 날짜 기본값 설정
        const now = new Date();
        const isoString = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
        $("#startDate").val(isoString);

        // 파일 업로드 처리
        $("#companyImage").on("change", function () {
            const filePreview = $("#filePreview");
            const newFiles = Array.from(this.files);

            // 최대 파일 수 체크
            if (filePreview.find(".img-container").length + newFiles.length > maxFiles) {
                alert(`이미지는 최대 ${maxFiles}개`);
                this.value = "";
                return;
            }

            // 새 파일 추가
            newFiles.forEach((file) => {
                const fileIndex = selectedFiles.findIndex(
                    (f) => f.name === file.name && f.size === file.size
                );
                if (fileIndex === -1) {
                    selectedFiles.push(file);

                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const slot = filePreview.find(".default-img").first();
                        const imgContainer = $('<div class="img-container"></div>');
                        const img = $("<img>")
                            .attr("src", e.target.result)
                            .attr("data-file-name", file.name)
                            .attr("data-file-size", file.size);

                        const deleteBtn = $('<span class="delete-img">x</span>');
                        imgContainer.append(img).append(deleteBtn);
                        slot.replaceWith(imgContainer);
                    };
                    reader.readAsDataURL(file);
                }
            });

            this.value = "";
        });


        // 삭제 버튼 처리
        $("#filePreview").on("click", ".delete-img", function () {
            const imgContainer = $(this).closest(".img-container");
            const imgFileName = imgContainer.find("img").attr("data-file-name");
            const imgFileSize = imgContainer.find("img").attr("data-file-size");

            console.log("삭제 시도 중인 파일 이름:", imgFileName, "파일 크기:", imgFileSize);
            console.log("현재 selectedFiles 상태:", selectedFiles);

            const fileIndex = selectedFiles.findIndex(
                (file) => file.name === imgFileName && file.size.toString() === imgFileSize
            );

            if (fileIndex !== -1) {
                console.log("삭제할 파일 인덱스:", fileIndex);
                console.log("삭제 파일 정보:", selectedFiles[fileIndex]);

                selectedFiles.splice(fileIndex, 1);
                imgContainer.remove();
                updatePreviewOrder();

                console.log("파일 삭제 완료.");
                console.log("삭제 후 updated selectedFiles 상태:", selectedFiles);
            } else {
                console.error("파일 삭제 실패: 파일을 찾을 수 없습니다.");
            }
        });

        // 미리보기 순서
        function updatePreviewOrder() {
            const filePreview = $("#filePreview");
            const imgContainers = filePreview.find(".img-container");
            const emptySlots = 3 - imgContainers.length;

            filePreview.empty();
            imgContainers.each((_, container) => filePreview.append(container));

            for (let i = 0; i < emptySlots; i++) {
                filePreview.append('<div class="default-img">이미지 없음</div>');
            }
        }

        // 기술 스택 추가/삭제
        $(".skill-button").on("click", function () {
            const skill = $(this).data("skill");
            if (!$(`.selected-skill-list .skill-tag[data-skill="${skill}"]`).length) {
                const skillTag = `
                    <div class="skill-tag" data-skill="${skill}">
                        <span class="skill-text">${skill}</span>
                        <span class="remove-skill" data-skill="${skill}">x</span>
                    </div>`;
                $(".selected-skill-list").append(skillTag);
            }
        });

        $(document).on("click", ".remove-skill", function () {
            $(this).closest(".skill-tag").remove();
        });
    });

    function handleSubmit(event) {
        event.preventDefault();

        const requestDto = {
            jTitle: document.querySelector("input[name='jobTitle']").value,
            jStitle: document.querySelector("input[name='jobSubtitle']").value,
            jContent: document.querySelector("textarea[name='jobDescription']").value,
            jGbnCd: "O",
            sDt: document.querySelector("input[name='startDate']").value,
            eDt: document.querySelector("input[name='endDate']").value,
            educatCd: document.querySelector("select[name='education']").value,
            careerCd: document.querySelector("select[name='experience']").value,
            preferences: document.querySelector("textarea[name='preferred']").value,
            workPlace: document.querySelector("input[name='workLocation']").value,
            workTime: "9 to 6",
            workType: document.querySelector("select[name='employmentType']").value,
            skillList: {
                jNo: null,
                skills: Array.from(document.querySelectorAll(".selected-skill-list .skill-tag .skill-text")).map(
                    (skill) => skill.textContent
                ),
            },
        };

        const formData = {
            jobOpeningRequest: requestDto,
            companyImages: [],
        };

        if (selectedFiles.length === 0) {
            alert("파일을 선택해주세요.");
            return;
        }

        selectedFiles.forEach((file) => {
            const reader = new FileReader();
            reader.onloadend = function () {
                const base64File = reader.result.split(",")[1];
                formData.companyImages.push({
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    content: base64File,
                });

                if (formData.companyImages.length === selectedFiles.length) {
                    axios
                        .post("/job-open", formData, {
                            headers: {
                                "Content-Type": "application/json; charset=utf-8",
                            },
                        })
                        .then((response) => {
                            alert("공고 등록이 완료되었습니다.");
                        })
                        .catch((error) => {
                            alert("공고 등록에 실패했습니다.");
                        });
                }
            };
            reader.readAsDataURL(file);
        });
    }
</script>

</script>
</body>
</html>
